# 시설 정보 캡션 미표시 문제 디버깅 가이드

## 문제 현상
- PDF 내 사진 아래 시설 정보(시설번호, 시설명, 용량)가 빈 공간으로 표시됨
- 클라이언트 PDF 생성 시 `facility_caption` 필드가 비어있는 것으로 추정

## 디버깅 단계

### 1단계: 네트워크 요청 확인
브라우저 개발자 도구 → Network 탭 → PDF 다운로드 실행

**확인할 요청:**
- `POST /api/export-photos-data`

**응답 JSON에서 확인:**
```json
{
  "success": true,
  "data": {
    "preventionPhotos": [
      {
        "facility_caption": "여기 값이 있어야 함", // ← 이 값 확인!
        "original_filename": "discharge1_2.5MB_001_250109.webp"
      }
    ]
  }
}
```

### 2단계: 서버 로그 확인
터미널에서 Next.js 로그 확인:

```
[EXPORT-DATA] 파일 정보: { file_path: '...', original_filename: '...' }
[EXPORT-DATA] 추출된 시설 정보: { facilityNumber: '배1', capacity: '2.5', ... }
[EXPORT-DATA] 생성된 캡션: '<배1> 2.5MB'
```

### 3단계: 파일명 패턴 확인
실제 업로드된 파일명이 예상 패턴과 일치하는지 확인:

**예상 패턴:**
- `discharge1_2.5MB_001_250109.webp`
- `prevention2_250㎥_002_250109.webp`

**매칭 정규식:** `/^(discharge|prevention)(\d+)_([^_]+)_\d+_\d+$/`

## 임시 해결 방법

만약 파일명이 패턴과 맞지 않는다면, 폴더명에서 추출하는 로직으로 폴백됩니다:
- 폴더 구조: `방지시설/<방1>여과집진시설/` → `<방1>여과집진시설`

## 근본 원인 후보

### A. 파일명 패턴 불일치
- 실제 파일명이 `discharge1_2.5MB_001_250109.webp` 형식이 아님
- 정규식 매칭 실패로 빈 캡션 생성

### B. 폴더명에도 시설 정보 없음
- 파일명 매칭 실패 후 폴더명 추출 시도
- 폴더 구조에 `<방1>` 같은 시설번호 없음
- 결과: 빈 캡션

### C. 게이트웨이 사진 오인식
- `isGatewayOrBasicPhoto()` 함수가 일반 시설 사진을 게이트웨이로 오인식
- 게이트웨이 캡션만 표시

## 다음 조치

1. **즉시 확인:** 브라우저 Network 탭에서 `facility_caption` 값 확인
2. **로그 확인:** 서버 터미널에서 `[EXPORT-DATA]` 로그 확인
3. **파일명 확인:** Supabase Storage에서 실제 파일명 형식 확인

## 예상 해결책

### 해결책 1: 파일명 패턴 수정
`lib/facilityInfoExtractor.ts:49` 정규식을 실제 파일명 패턴에 맞게 수정

### 해결책 2: 폴더명 추출 로직 강화
폴더 구조에서 시설 정보를 더 정확하게 추출하도록 개선

### 해결책 3: 디버그 로그 추가
캡션 생성 과정의 중간 값들을 모두 로깅하여 어디서 실패하는지 정확히 파악
