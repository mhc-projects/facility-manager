# Phase 1 Hotfix - 테스트 가이드

## ✅ 적용 완료
- **파일**: `app/api/admin/tasks/bulk-upload/route.ts`
- **변경**: REVERSE_TASK_TYPE_MAP에 3개 매핑 추가
  - `'자비': 'self'`
  - `'외주설치': 'outsourcing'`
  - `'기타': 'etc'`

---

## 🧪 로컬 테스트 절차

### 1. 개발 서버 재시작
```bash
# 현재 디렉토리 확인
pwd  # /Users/mh.c/claude/facility-manager

# 개발 서버 재시작
npm run dev
# 또는
npm run dev-mobile
```

### 2. 테스트 엑셀 파일 준비

**테스트 데이터 (test-bulk-upload.xlsx)**:
| 사업장명 | 업무타입 | 현재단계 | 담당자 | 메모 |
|---------|---------|---------|--------|------|
| 테스트사업장1 | 자비 | 고객 상담 | 김철수 | 자비 타입 테스트 |
| 테스트사업장2 | 외주설치 | 고객 상담 | 이영희 | 외주설치 타입 테스트 |
| 테스트사업장3 | 기타 | 기타 | 박민수 | 기타 타입 테스트 |

> **주의**: 사업장명과 담당자는 실제 DB에 존재하는 값으로 수정해야 함

### 3. 업로드 테스트
1. 브라우저에서 `http://localhost:3000/admin/tasks` 접속
2. 로그인 (관리자 권한 4 필요)
3. "일괄 등록" 버튼 클릭
4. 테스트 엑셀 파일 업로드
5. 데이터 확인 화면에서 "정상" 표시 확인
6. "3개 업무 등록" 버튼 클릭

### 4. 결과 확인

#### 4.1 성공 메시지 확인
```
✅ 총 3개 업무 처리 완료
   • 신규 생성: 3개
```

#### 4.2 브라우저 콘솔 확인 (F12)
```javascript
// 예상 로그
✅ [BULK-UPLOAD] 일괄 처리 완료: {
  created: 3,
  updated: 0,
  skipped: 0,
  fail: 0,
  invalid: 0
}
```

#### 4.3 칸반보드 확인
- "고객 상담" 컬럼에 2개 업무 표시
- "기타" 컬럼에 1개 업무 표시

#### 4.4 업무타입 필터 확인
- "자비" 필터: 1개 표시
- "외주설치" 필터: 1개 표시
- "기타" 필터: 1개 표시

---

## 🔍 유효성 검사 실패 시나리오 테스트

### 테스트 1: 잘못된 업무타입
**엑셀 데이터**:
| 사업장명 | 업무타입 | 현재단계 | 담당자 | 메모 |
|---------|---------|---------|--------|------|
| 테스트사업장 | 자비설치 | 고객 상담 | 김철수 | 잘못된 타입 |

**예상 결과**:
- ❌ 오류: `업무타입 "자비설치"이 유효하지 않습니다. "자가", "보조금", "AS" 중 하나를 입력하세요.`

### 테스트 2: 존재하지 않는 사업장
**엑셀 데이터**:
| 사업장명 | 업무타입 | 현재단계 | 담당자 | 메모 |
|---------|---------|---------|--------|------|
| 없는사업장123 | 자비 | 고객 상담 | 김철수 | 잘못된 사업장 |

**예상 결과**:
- ❌ 오류: `사업장 "없는사업장123"을 찾을 수 없습니다`

---

## 📊 실제 데이터 복구 테스트

### Step 1: 백업 확인
```bash
# 현재 업무 개수 확인
# (데이터베이스 직접 접근 필요)
```

### Step 2: 원본 엑셀 파일 업로드
1. 원본 3132개 데이터 파일 준비
2. 일괄 등록 실행
3. **예상 결과**:
   ```
   ✅ 총 3050개 업무 처리 완료
      • 신규 생성: 3050개
   ⏭️ 건너뛰기: 82개
   ```

### Step 3: 최종 확인
- 칸반보드에 총 3132개 업무 표시
- 업무타입별 분포 확인:
  - 자비: ~3000개
  - 보조금: ~100개
  - 기타: ~32개

---

## ⚠️ 주의사항

### 1. 관리자 권한 필요
- 일괄 등록 기능은 권한 레벨 4만 사용 가능
- 테스트 시 관리자 계정으로 로그인 필요

### 2. 사업장명 정확성
- 엑셀의 사업장명은 DB의 `business_info.business_name`과 정확히 일치해야 함
- 띄어쓰기, 오타 주의

### 3. 담당자명 정확성
- 엑셀의 담당자명은 DB의 `employees.name`과 정확히 일치해야 함
- 존재하지 않는 담당자는 경고만 표시하고 진행됨

### 4. 중복 업무 처리
- 같은 사업장 + 같은 업무타입 + 같은 상태 = 중복
- 중복 시 빈 필드만 업데이트
- 업데이트할 빈 필드가 없으면 건너뛰기

---

## ✅ 테스트 체크리스트

- [ ] 개발 서버 재시작 완료
- [ ] "자비" 타입 테스트 성공
- [ ] "외주설치" 타입 테스트 성공
- [ ] "기타" 타입 테스트 성공
- [ ] 칸반보드에 정상 표시 확인
- [ ] 업무타입 필터 동작 확인
- [ ] 잘못된 타입 오류 확인
- [ ] 원본 데이터 복구 테스트 준비

---

## 🐛 문제 발생 시 확인사항

### 1. API 오류
- 브라우저 콘솔(F12) → Network 탭 확인
- `/api/admin/tasks/bulk-upload` 응답 확인
- 서버 터미널 로그 확인

### 2. 유효성 검사 실패
- 엑셀 데이터 확인:
  - 사업장명이 DB에 존재하는지
  - 담당자명이 DB에 존재하는지
  - 현재단계가 유효한 값인지

### 3. 서버 재시작 필요
```bash
# 개발 서버 종료 (Ctrl+C)
# 다시 시작
npm run dev
```

---

## 📝 다음 단계

Phase 1 Hotfix 테스트 완료 후:
1. Phase 2: 프론트엔드 유효성 검사 강화
2. Phase 3: 오류 리포팅 개선
3. Phase 4: 공통 매핑 모듈화

각 Phase는 이전 Phase가 안정적으로 동작하는 것을 확인한 후 진행합니다.
