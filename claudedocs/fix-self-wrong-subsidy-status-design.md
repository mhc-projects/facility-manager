# ìë¹„ ì—…ë¬´ì˜ ì˜ëª»ëœ ë³´ì¡°ê¸ˆ ìƒíƒœ ìˆ˜ì • ì„¤ê³„

## ë¬¸ì œ ìƒí™©

### í˜„ìƒ
- admin/tasks í˜ì´ì§€ì—ì„œ **ì—…ë¬´ íƒ€ì…ì´ `self`(ìë¹„)ì¸ë° ì—…ë¬´ ë‹¨ê³„ê°€ "ë³´ì¡°ê¸ˆ ì…ê¸ˆ"ìœ¼ë¡œ í‘œì‹œ**ë˜ëŠ” ì‚¬ì—…ì¥ ë°œê²¬
- ëŒ€í‘œ ì‚¬ë¡€: **íƒœìš°ì„¬ìœ ** ì‚¬ì—…ì¥

### ì›ì¸ ë¶„ì„
ì—…ë¬´ ë“±ë¡ ì‹œ ìƒíƒœë¥¼ ì˜ëª» ì„ íƒí•˜ì—¬ ë°œìƒ:
- `task_type`: `self` (ìë¹„)
- `status`: `subsidy_payment_received` (ë³´ì¡°ê¸ˆ ì…ê¸ˆ) â† **ì˜ëª»ëœ ìƒíƒœ**

### ë°ì´í„° ë¶ˆì¼ì¹˜
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì—…ë¬´ íƒ€ì…: self (ìë¹„)                       â”‚
â”‚ ì—…ë¬´ ìƒíƒœ: subsidy_payment_received        â”‚  â† ğŸš¨ ë¶ˆì¼ì¹˜!
â”‚           (ë³´ì¡°ê¸ˆ ì…ê¸ˆ)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì •ìƒ ìƒíƒœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì—…ë¬´ íƒ€ì…: self (ìë¹„)                       â”‚
â”‚ ì—…ë¬´ ìƒíƒœ: self_document_complete          â”‚  â† âœ… ì •ìƒ
â”‚           (ì„œë¥˜ ë°œì†¡ ì™„ë£Œ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ìˆ˜ì • ë°©ì•ˆ

### ëª©í‘œ
`task_type`ì´ `self`ì¸ë° `status`ê°€ `subsidy_`ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ì—…ë¬´ë¥¼ `self_document_complete`ë¡œ ë³€ê²½

### ìˆ˜ì • ìƒíƒœ ë§¤í•‘
```
ë³€ê²½ ì „: subsidy_payment_received (ë³´ì¡°ê¸ˆ ì…ê¸ˆ)
ë³€ê²½ í›„: self_document_complete (ì„œë¥˜ ë°œì†¡ ì™„ë£Œ)

ì´ìœ :
1. ìë¹„ ì—…ë¬´ëŠ” ë³´ì¡°ê¸ˆ ê´€ë ¨ ìƒíƒœë¥¼ ê°€ì§ˆ ìˆ˜ ì—†ìŒ
2. ì„œë¥˜ ë°œì†¡ ì™„ë£ŒëŠ” ìë¹„ ì—…ë¬´ì˜ ìµœì¢… ë‹¨ê³„
3. ì˜ë¯¸ì ìœ¼ë¡œ ê°€ì¥ ì í•©í•œ ìƒíƒœ
```

## êµ¬í˜„ ì„¤ê³„

### 1. ìŠ¤í¬ë¦½íŠ¸ ê¸°ëŠ¥

#### ì¡°íšŒ ëª¨ë“œ (ê¸°ë³¸)
```bash
node scripts/fix-self-wrong-status.js
```

**ë™ì‘:**
1. `task_type = 'self'` AND `status LIKE 'subsidy_%'` ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒ
2. ì‚¬ì—…ì¥ë³„ ê·¸ë£¹í•‘í•˜ì—¬ ê²°ê³¼ ì¶œë ¥
3. ìˆ˜ì • ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸° ì œê³µ
4. ìˆ˜ì • ë°©ë²• ì•ˆë‚´

**ì¶œë ¥ ì˜ˆì‹œ:**
```
ğŸ” ìë¹„ ì—…ë¬´ ì¤‘ ë³´ì¡°ê¸ˆ ìƒíƒœë¥¼ ê°€ì§„ ì‚¬ì—…ì¥ ì¡°íšŒ...

ğŸ“Š ë°œê²¬ëœ ì—…ë¬´ ìˆ˜: 3ê°œ

ğŸ“‹ ìë¹„ ì—…ë¬´ì¸ë° ë³´ì¡°ê¸ˆ ìƒíƒœë¥¼ ê°€ì§„ ì‚¬ì—…ì¥:

[1] íƒœìš°ì„¬ìœ 
    ì—…ë¬´ ìˆ˜: 1ê°œ
    1. ID: abc123...
       ì œëª©: íƒœìš°ì„¬ìœ  - ìë¹„ ì„¤ì¹˜
       ì—…ë¬´íƒ€ì…: self
       í˜„ì¬ìƒíƒœ: subsidy_payment_received
       ë‹´ë‹¹ì: í™ê¸¸ë™
       ìƒì„±ì¼: 2024-01-15 14:30:00

[2] ë‹¤ë¥¸ì‚¬ì—…ì¥
    ì—…ë¬´ ìˆ˜: 2ê°œ
    ...

ğŸ’¡ ìˆ˜ì • ë°©ë²•:
   node scripts/fix-self-wrong-status.js --fix
```

#### ìˆ˜ì • ëª¨ë“œ (--fix)
```bash
node scripts/fix-self-wrong-status.js --fix
```

**ë™ì‘:**
1. ìˆ˜ì • ëŒ€ìƒ ì¡°íšŒ ë° ë¯¸ë¦¬ë³´ê¸°
2. 3ì´ˆ + 5ì´ˆ ëŒ€ê¸° (ì•ˆì „ì¥ì¹˜)
3. ê° ì—…ë¬´ì˜ `status`ë¥¼ `self_document_complete`ë¡œ ì—…ë°ì´íŠ¸
4. `updated_at` íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹ 
5. ì„±ê³µ/ì‹¤íŒ¨ ê²°ê³¼ ì¶œë ¥

**ì•ˆì „ ì¥ì¹˜:**
- 3ì´ˆ ì´ˆê¸° ëŒ€ê¸°
- ìƒì„¸ ë¯¸ë¦¬ë³´ê¸° ì¶œë ¥
- 5ì´ˆ ìµœì¢… í™•ì¸ ëŒ€ê¸°
- Ctrl+Cë¡œ ì–¸ì œë“  ì·¨ì†Œ ê°€ëŠ¥

### 2. SQL ì¿¼ë¦¬ ë¡œì§

#### ì¡°íšŒ ì¿¼ë¦¬
```sql
SELECT
  id,
  business_name,
  task_type,
  status,
  title,
  created_at,
  assignee
FROM facility_tasks
WHERE is_active = true
  AND is_deleted = false
  AND task_type = 'self'
  AND status LIKE 'subsidy_%'
ORDER BY business_name, created_at;
```

#### ìˆ˜ì • ì¿¼ë¦¬
```sql
UPDATE facility_tasks
SET
  status = 'self_document_complete',
  updated_at = NOW()
WHERE id = '[task_id]'
  AND is_active = true
  AND is_deleted = false
  AND task_type = 'self'
  AND status LIKE 'subsidy_%';
```

### 3. ì½”ë“œ êµ¬ì¡°

```javascript
// 1. ì¡°íšŒ í•¨ìˆ˜
async function findSelfWithSubsidyStatus() {
  // - Supabase ì¡°íšŒ
  // - ì‚¬ì—…ì¥ë³„ ê·¸ë£¹í•‘
  // - ê²°ê³¼ ì¶œë ¥
  // - ìˆ˜ì • ë°©ë²• ì•ˆë‚´
}

// 2. ìˆ˜ì • í•¨ìˆ˜
async function fixSelfWithSubsidyStatus() {
  // - ëŒ€ê¸° ì‹œê°„ (3ì´ˆ)
  // - ìˆ˜ì • ëŒ€ìƒ ì¡°íšŒ
  // - ë¯¸ë¦¬ë³´ê¸° ì¶œë ¥
  // - ìµœì¢… í™•ì¸ ëŒ€ê¸° (5ì´ˆ)
  // - ì—…ë°ì´íŠ¸ ì‹¤í–‰
  // - ê²°ê³¼ ìš”ì•½
}

// 3. ë©”ì¸ ì‹¤í–‰
if (--fix) {
  fixSelfWithSubsidyStatus()
} else {
  findSelfWithSubsidyStatus()
}
```

## ì‚¬ìš© ê°€ì´ë“œ

### Step 1: í˜„í™© í™•ì¸
```bash
node scripts/fix-self-wrong-status.js
```

**í™•ì¸ ì‚¬í•­:**
- ì˜í–¥ ë°›ëŠ” ì‚¬ì—…ì¥ ëª©ë¡
- ê° ì‚¬ì—…ì¥ì˜ í˜„ì¬ ìƒíƒœ
- ì´ ìˆ˜ì • ëŒ€ìƒ ì—…ë¬´ ìˆ˜

### Step 2: ìˆ˜ì • ì‹¤í–‰
```bash
node scripts/fix-self-wrong-status.js --fix
```

**ì§„í–‰ ê³¼ì •:**
1. â³ 3ì´ˆ ëŒ€ê¸°
2. ğŸ“‹ ìˆ˜ì • ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸° ì¶œë ¥
3. â³ 5ì´ˆ ìµœì¢… í™•ì¸
4. ğŸ”„ ìˆ˜ì • ì‹¤í–‰
5. ğŸ“Š ê²°ê³¼ ìš”ì•½

**ì˜ˆìƒ ì¶œë ¥:**
```
âš ï¸  ìë¹„ ì—…ë¬´ì˜ ë³´ì¡°ê¸ˆ ìƒíƒœë¥¼ ì„œë¥˜ ë°œì†¡ ì™„ë£Œë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.

3ì´ˆ í›„ ì‹œì‘í•©ë‹ˆë‹¤...

ğŸ“‹ ìˆ˜ì • ëŒ€ìƒ: 3ê°œ

ğŸ” ìˆ˜ì • ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸°:

[1] íƒœìš°ì„¬ìœ 
    í˜„ì¬: subsidy_payment_received
    ë³€ê²½: self_document_complete (ì„œë¥˜ ë°œì†¡ ì™„ë£Œ)
    ì œëª©: íƒœìš°ì„¬ìœ  - ìë¹„ ì„¤ì¹˜

...

âš ï¸  ì´ 3ê°œ ì—…ë¬´ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

5ì´ˆ í›„ ìˆ˜ì •ì´ ì‹œì‘ë©ë‹ˆë‹¤... (Ctrl+Cë¡œ ì·¨ì†Œ)

ğŸ”„ ìˆ˜ì • ì‹œì‘...

  âœ… íƒœìš°ì„¬ìœ : subsidy_payment_received â†’ self_document_complete
  âœ… ë‹¤ë¥¸ì‚¬ì—…ì¥: subsidy_payment_received â†’ self_document_complete

ğŸ“Š ìˆ˜ì • ì™„ë£Œ ìš”ì•½

  âœ… ì„±ê³µ: 3ê°œ
  âŒ ì‹¤íŒ¨: 0ê°œ
  ğŸ“Š ì „ì²´: 3ê°œ

âœ… ëª¨ë“  ì—…ë¬´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!
```

### Step 3: ê²€ì¦
admin/tasks í˜ì´ì§€ì—ì„œ í™•ì¸:
- íƒœìš°ì„¬ìœ  ì‚¬ì—…ì¥ì˜ ì—…ë¬´ ë‹¨ê³„ê°€ "ì„œë¥˜ ë°œì†¡ ì™„ë£Œ"ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
- ë‹¤ë¥¸ ìë¹„ ì‚¬ì—…ì¥ë“¤ë„ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

## ì˜í–¥ ë¶„ì„

### ë°ì´í„° ë³€ê²½
- **í…Œì´ë¸”**: `facility_tasks`
- **í•„ë“œ**: `status`, `updated_at`
- **ì˜í–¥ ë²”ìœ„**: `task_type='self'` AND `status LIKE 'subsidy_%'` ì¡°ê±´ì˜ ì—…ë¬´ë§Œ

### UI ì˜í–¥
- admin/tasks í˜ì´ì§€ì—ì„œ í•´ë‹¹ ì‚¬ì—…ì¥ì˜ ë‹¨ê³„ í‘œì‹œ ì •ìƒí™”
- ì¹¸ë°˜ë³´ë“œì—ì„œ ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ì— ë°°ì¹˜
- ì§„í–‰ë¥  ê³„ì‚° ì •í™•ë„ í–¥ìƒ

### ë¶€ì‘ìš© ì—†ìŒ
- ë‹¤ë¥¸ ì—…ë¬´ íƒ€ì…(ë³´ì¡°ê¸ˆ, ëŒ€ë¦¬ì  ë“±)ì—ëŠ” ì˜í–¥ ì—†ìŒ
- ì´ë¯¸ ì˜¬ë°”ë¥¸ ìƒíƒœë¥¼ ê°€ì§„ ìë¹„ ì—…ë¬´ëŠ” ì˜í–¥ ì—†ìŒ
- soft deleteë‚˜ is_active ìƒíƒœëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ

## ì˜ˆë°© ì¡°ì¹˜

### ê·¼ë³¸ ì›ì¸
ì—…ë¬´ ë“±ë¡ ì‹œ ìƒíƒœ ì„ íƒì—ì„œ ì—…ë¬´ íƒ€ì…ê³¼ ë§ì§€ ì•ŠëŠ” ìƒíƒœ ì„ íƒ ê°€ëŠ¥

### í–¥í›„ ê°œì„  ë°©ì•ˆ

#### 1. UI ë ˆë²¨ ê²€ì¦
ì—…ë¬´ ìƒì„±/ìˆ˜ì • í¼ì—ì„œ:
```typescript
// ì—…ë¬´ íƒ€ì…ì— ë”°ë¥¸ ìƒíƒœ í•„í„°ë§
const getAvailableStatuses = (taskType: TaskType) => {
  switch (taskType) {
    case 'self':
      return selfSteps.map(s => s.status)
    case 'subsidy':
      return subsidySteps.map(s => s.status)
    case 'dealer':
      return dealerSteps.map(s => s.status)
    // ...
  }
}
```

#### 2. API ë ˆë²¨ ê²€ì¦
```typescript
// POST/PUT /api/facility-tasks
const validateStatusForTaskType = (taskType: TaskType, status: TaskStatus) => {
  const prefix = status.split('_')[0]
  if (taskType !== prefix) {
    throw new Error(`Invalid status '${status}' for task type '${taskType}'`)
  }
}
```

#### 3. ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ì¡°ê±´
```sql
-- Check constraint ì¶”ê°€
ALTER TABLE facility_tasks
ADD CONSTRAINT check_status_matches_type
CHECK (
  (task_type = 'self' AND status LIKE 'self_%') OR
  (task_type = 'subsidy' AND status LIKE 'subsidy_%') OR
  (task_type = 'dealer' AND status LIKE 'dealer_%') OR
  (task_type = 'as' AND status LIKE 'as_%') OR
  (task_type = 'outsourcing' AND status LIKE 'outsourcing_%') OR
  (task_type = 'etc' AND status LIKE 'etc_%')
);
```

## íŒŒì¼ ëª©ë¡

### ìƒˆë¡œ ìƒì„±
- `scripts/fix-self-wrong-status.js` - ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸
- `claudedocs/fix-self-wrong-subsidy-status-design.md` - ì„¤ê³„ ë¬¸ì„œ

## ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Step 1: í˜„í™© í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  ```bash
  node scripts/fix-self-wrong-status.js
  ```
- [ ] Step 2: ì˜í–¥ ë°›ëŠ” ì‚¬ì—…ì¥ í™•ì¸
  - íƒœìš°ì„¬ìœ  í¬í•¨ ì—¬ë¶€ í™•ì¸
  - ì´ ì—…ë¬´ ìˆ˜ í™•ì¸
- [ ] Step 3: ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  ```bash
  node scripts/fix-self-wrong-status.js --fix
  ```
- [ ] Step 4: ê²°ê³¼ í™•ì¸
  - ì„±ê³µ ê°œìˆ˜ í™•ì¸
  - ì‹¤íŒ¨ ì—¬ë¶€ í™•ì¸
- [ ] Step 5: UI ê²€ì¦
  - admin/tasks í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  - íƒœìš°ì„¬ìœ  ë‹¨ê³„ í™•ì¸: "ì„œë¥˜ ë°œì†¡ ì™„ë£Œ"
  - ì¹¸ë°˜ë³´ë“œ ë°°ì¹˜ í™•ì¸

## ë¡¤ë°± ë°©ë²•

ë§Œì•½ ìˆ˜ì • í›„ ë¬¸ì œê°€ ë°œìƒí•˜ë©´:

```sql
-- íŠ¹ì • ì—…ë¬´ ì›ë³µ (ìˆ˜ì • ì „ ìƒíƒœ ê¸°ì–µ í•„ìš”)
UPDATE facility_tasks
SET
  status = 'subsidy_payment_received',  -- ì›ë˜ ìƒíƒœ
  updated_at = NOW()
WHERE id = '[task_id]';

-- ë˜ëŠ” ë°±ì—… ë°ì´í„°ê°€ ìˆë‹¤ë©´
-- (ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ ë°±ì—… ê¶Œì¥)
```

## ì™„ë£Œ ê¸°ì¤€

âœ… ëª¨ë“  ìë¹„ ì—…ë¬´ê°€ ìë¹„ ì „ìš© ìƒíƒœë§Œ ê°€ì§
âœ… íƒœìš°ì„¬ìœ ë¥¼ í¬í•¨í•œ ëª¨ë“  ëŒ€ìƒ ì‚¬ì—…ì¥ ìˆ˜ì • ì™„ë£Œ
âœ… admin/tasks í˜ì´ì§€ì—ì„œ ì •ìƒ í‘œì‹œ í™•ì¸
âœ… ì—ëŸ¬ ì—†ì´ 100% ì„±ê³µ
